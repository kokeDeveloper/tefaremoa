# Copilot Instructions for Te Fare Mo'a

- Stack: Next.js 15 (app router) + TypeScript + Tailwind; Prisma client emitted to src/app/generated/prisma targeting MySQL; JWT auth without NextAuth. Key configs in [next.config.mjs](next.config.mjs) and [tsconfig.json](tsconfig.json).
- Admin-only middleware guards /admin except login/SSO and static assets, redirects based on FORCE_SSO/NEXT_PUBLIC_FORCE_SSO and token presence; see [middleware.ts](middleware.ts).
- Auth: JWT signed with JWT_SECRET, stored as cookie `token`. Manual cookie parsing in API routes; token verification via [src/lib/auth.ts](src/lib/auth.ts) (alias re-export in [src/lib/jwt.ts](src/lib/jwt.ts)). Default seed admin from [prisma/seed.ts](prisma/seed.ts) uses email napatalama@gmail.com / password 123momia.
- SSO flow: admin entry [src/app/admin/page.tsx](src/app/admin/page.tsx) checks token then redirects to SSO URL (NEXT_PUBLIC_SSO_URL) or local login in dev; fallback SSO page in [src/app/admin/sso/page.tsx](src/app/admin/sso/page.tsx). Local login UI at [src/app/admin/login/page.tsx](src/app/admin/login/page.tsx) posts to /api/auth/login.
- Auth APIs: [src/app/api/auth/login/route.ts](src/app/api/auth/login/route.ts) validates admin with Prisma + bcrypt, sets `token` httpOnly; [src/app/api/auth/logout/route.ts](src/app/api/auth/logout/route.ts) clears it; [src/app/api/auth/sso/route.ts](src/app/api/auth/sso/route.ts) accepts email/sso_token query, issues token and redirects. Me endpoint [src/app/api/admin/me/route.ts](src/app/api/admin/me/route.ts).
- Data model: see [prisma/schema.prisma](prisma/schema.prisma) for Student, Plan, Class, Instructor, Enrollment, Payment, Attendance, Admin (roles enum). Plan status recalculated via [src/lib/planAlerts.ts](src/lib/planAlerts.ts).
- Student CRUD API: [src/app/api/students/route.ts](src/app/api/students/route.ts) list/create with search, pagination (skip/take), sets planStatus using calculatePlanAlertWithStatus; [src/app/api/students/[id]/route.ts](src/app/api/students/%5Bid%5D/route.ts) get/update/delete (hashes password on update, cascades delete of related records).
- Payments API: [src/app/api/payments/route.ts](src/app/api/payments/route.ts) list/create with filters studentId/from/to; [src/app/api/payments/[id]/route.ts](src/app/api/payments/%5Bid%5D/route.ts) CRUD. Uses same token gate.
- Dashboard data APIs: summary at [src/app/api/dashboard/summary/route.ts](src/app/api/dashboard/summary/route.ts) (uses getDashboardSummary in [src/lib/dashboardMetrics.ts](src/lib/dashboardMetrics.ts)); financials at [src/app/api/dashboard/financials/route.ts](src/app/api/dashboard/financials/route.ts) (uses getFinancialMetrics in [src/lib/financialMetrics.ts](src/lib/financialMetrics.ts)).
- Alerts APIs: payment reminders at [src/app/api/alerts/payment-reminders/route.ts](src/app/api/alerts/payment-reminders/route.ts) (getPaymentReminderData); plan expirations at [src/app/api/alerts/plan-expiring/route.ts](src/app/api/alerts/plan-expiring/route.ts) with days/includeNoPlan query.
- Admin UI: main client dashboard [src/app/admin/AdminDashboardClient.tsx](src/app/admin/AdminDashboardClient.tsx) fetches summary/alerts/financials via fetch with credentials include, switches between dashboard and students via search param. Student management components in [src/app/admin/components](src/app/admin/components) and [src/app/admin/students/components](src/app/admin/students/components) use the above APIs; plan alerts panel shows stale planStatus warnings when calculated alert differs from stored status.
- UI patterns: Tailwind utility classes with cn() helper [src/util/cn.ts](src/util/cn.ts); custom UI primitives in [src/components/ui](src/components/ui). Charts via recharts; icons via @tabler/icons-react.
- Dev commands: `npm run dev` to start Next on 3000; `npm run build` + `npm start` serves on port 3001 (see server.js for simple HTTP placeholder). Prisma seed with `npm run seed` or `npm run seed:run` (tsx prisma/seed.ts). E2E API sanity test with `npm run test:e2e` (Playwright; expects admin creds and optional E2E_BASE_URL).
- Environment: DATABASE_URL required for Prisma; JWT_SECRET for token signing (defaults to dev-secret); NEXT_PUBLIC_SSO_URL optional (relative ok for local); FORCE_SSO/NEXT_PUBLIC_FORCE_SSO force redirect to SSO. Middleware uses NODE_ENV to allow local login.
- Conventions: Prefer importing Prisma client from src/app/generated/prisma; many API handlers instantiate new PrismaClient and disconnect in finally—follow this pattern or extract shared singleton carefully. Authorization is cookie-based; every admin API manually validates `token`—match that when adding endpoints. Keep planStatus in sync using calculatePlanAlertWithStatus on student creates/updates.
- Testing/fixtures: seed sets one admin; test/e2e/student.spec.ts logs in via API, creates and deletes a student to validate flow.

If anything here is unclear or you see gaps for your task, tell me what to expand or adjust.
